# Updates Summary - October 16, 2025

## 1. Fixed Test Connection Bug in Settings

### Problem
The "Test Connection" feature in the settings page was incorrectly showing "Connection Successful" even when wrong credentials were entered.

### Root Cause
The patients API endpoint (`/api/maxillo/patients/`) was publicly accessible without authentication. The login method was checking the API response instead of verifying whether the login itself succeeded.

### Solution
Modified `core/api_client.py` to check for the presence of the `sessionid` cookie instead of testing the API:
- Successful login: Django returns HTTP 302 (redirect) + sets `sessionid` cookie
- Failed login: Django returns HTTP 200 (form redisplay) + NO `sessionid` cookie

The login method now properly validates credentials by checking if the sessionid cookie was set, rather than relying on the API endpoint response.

### Files Modified
- `core/api_client.py` - Updated `login()` and `set_credentials()` methods

---

## 2. Added Console Log Viewer

### Features
A new console log viewer has been added to help diagnose issues, especially useful when running the application on different PCs.

### Location
**Help → View Console Log**

### Capabilities
- **Real-time viewing**: View application logs with color-coded severity levels
  - DEBUG (gray)
  - INFO (cyan)
  - WARNING (yellow)
  - ERROR (red)
  - CRITICAL (red with dark background)

- **Filtering**:
  - Filter by log level (ALL, DEBUG, INFO, WARNING, ERROR, CRITICAL)
  - Search for specific text with highlighting
  
- **Auto-refresh**: Optional 2-second auto-refresh to see logs in real-time

- **Log Management**:
  - Refresh log view
  - Clear log file
  - Save log to different location
  - Open log folder in File Explorer

### Files Added
- `gui/log_viewer.py` - New log viewer window component

### Files Modified
- `main.py` - Added comprehensive logging setup
- `gui/main_window.py` - Added "View Console Log" menu item

---

## 3. Enhanced NIfTI Conversion Diagnostics

### Problem
CBCT to NIfTI conversion using `dcm2niix` can fail on different PCs due to:
- Missing dcm2niix installation
- Wrong installation path
- DICOM file issues
- Permission problems

### Solution
Added extensive logging throughout the conversion process to help diagnose issues:

1. **dcm2niix Detection Logging**:
   - Logs all search locations (virtual environment, project .venv, system PATH)
   - Shows exactly where dcm2niix was found or why it wasn't found
   - Provides installation instructions when not found

2. **Conversion Process Logging**:
   - Logs DICOM folder path and file count
   - Logs the exact dcm2niix command being executed
   - Captures and logs both stdout and stderr from dcm2niix
   - Logs file sizes and locations of generated files
   - Detailed error messages with stack traces

3. **Helpful Error Messages**:
   When dcm2niix is not found, the log shows:
   ```
   ERROR: dcm2niix executable not found in any location
   ERROR: Please install dcm2niix using one of these methods:
   ERROR:   1. pip install dcm2niix
   ERROR:   2. Download from https://github.com/rordenlab/dcm2niix/releases
   ERROR:   3. Install via conda: conda install -c conda-forge dcm2niix
   ```

### Files Modified
- `core/cbct_converter.py` - Enhanced logging in conversion methods

---

## 4. Made python-magic-bin Optional

### Problem
The `python-magic-bin` library was required but is only used as a fallback for DICOM file detection.

### Solution
Made the library optional:
- Primary DICOM detection uses `pydicom` (always available)
- `python-magic-bin` is only used as a backup MIME type detector
- Application now runs fine without it, just shows a warning in the log

### Benefits
- Easier installation on different systems
- Fewer required dependencies
- Better error handling

### Files Modified
- `core/file_analyzer.py` - Made magic import optional with fallback

---

## How to Use the Console Log Viewer

### For Troubleshooting NIfTI Conversion Issues:

1. **Open the application**
2. **Go to Help → View Console Log**
3. **Try to analyze a project with CBCT files**
4. **Watch the log viewer** (enable auto-refresh) to see:
   - Whether dcm2niix is found
   - The exact command being run
   - Any errors from dcm2niix
   - File paths and sizes

5. **Filter by ERROR level** to quickly find problems
6. **Search for "dcm2niix"** to see all conversion-related messages
7. **Save the log file** to share with developers if needed

### Log File Location
Logs are stored in: `logs/tf4m_app.log` in the application directory

---

## Testing

All changes have been tested:
- ✅ Wrong credentials are now correctly rejected
- ✅ Log viewer opens and displays logs correctly
- ✅ Logging is working throughout the application
- ✅ Application runs without python-magic-bin installed
- ✅ Enhanced diagnostics provide detailed error information

---

## Notes for Deployment

When deploying to a new PC, make sure to:
1. Install Python dependencies: `pip install -r requirements.txt`
2. Install dcm2niix if CBCT conversion is needed:
   - `pip install dcm2niix`, OR
   - Download from https://github.com/rordenlab/dcm2niix/releases
3. Check the console log if any issues occur during analysis or upload
